<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Evo C++ Library v0.5.1: evo/event.h Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Evo C++ Library v0.5.1
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_eea27f8533654b579e42dec4bd98187a.html">evo</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">event.h</div>  </div>
</div><!--header-->
<div class="contents">
<a href="event_8h.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">// Evo C++ Library</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">/* Copyright 2019 Justin Crowell</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">Distributed under the BSD 2-Clause License -- see included file LICENSE.txt for details.</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">*/</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="preprocessor">#pragma once</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="preprocessor">#ifndef INCL_evo_event_h</span></div><div class="line"><a name="l00009"></a><span class="lineno"><a class="line" href="event_8h.html#a01650b9975313007c8f2149a5a5ae310">    9</a></span>&#160;<span class="preprocessor">#define INCL_evo_event_h</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="atomic_8h.html">atomic.h</a>&quot;</span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="preprocessor">#if defined(EVO_CPP11)</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="preprocessor">    #include &lt;functional&gt;</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="keyword">namespace </span><a class="code" href="namespaceevo.html">evo</a> {</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;</div><div class="line"><a name="l00031"></a><span class="lineno"><a class="line" href="structevo_1_1_event.html">   31</a></span>&#160;<span class="keyword">struct </span><a class="code" href="structevo_1_1_event.html">Event</a> {</div><div class="line"><a name="l00033"></a><span class="lineno"><a class="line" href="structevo_1_1_event.html#a85b9e8172cffad1f169d55688e49a72f">   33</a></span>&#160;    <a class="code" href="structevo_1_1_event.html#a85b9e8172cffad1f169d55688e49a72f">Event</a>()</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;        { }</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div><div class="line"><a name="l00037"></a><span class="lineno"><a class="line" href="structevo_1_1_event.html#aa28124883bfb17601f85db7e635094b1">   37</a></span>&#160;    <span class="keyword">virtual</span> <a class="code" href="structevo_1_1_event.html#aa28124883bfb17601f85db7e635094b1">~Event</a>()</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;        { }</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    <span class="keyword">virtual</span> <span class="keywordtype">bool</span> <a class="code" href="structevo_1_1_event.html#af098c25159582e982ca735262b4df169">operator()</a>() = 0;</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;};</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="preprocessor">#if defined(EVO_CPP11)</span></div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;</div><div class="line"><a name="l00059"></a><span class="lineno"><a class="line" href="classevo_1_1_event_lambda.html">   59</a></span>&#160;<span class="keyword">class </span><a class="code" href="classevo_1_1_event_lambda.html">EventLambda</a> : <span class="keyword">public</span> <a class="code" href="structevo_1_1_event.html">Event</a> {</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="keyword">public</span>:</div><div class="line"><a name="l00061"></a><span class="lineno"><a class="line" href="classevo_1_1_event_lambda.html#a6f89de73c7b46231ac5a1b220123c16a">   61</a></span>&#160;    <span class="keyword">typedef</span> std::function&lt;bool()&gt; <a class="code" href="classevo_1_1_event_lambda.html#a6f89de73c7b46231ac5a1b220123c16a">Lambda</a>;   </div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;</div><div class="line"><a name="l00066"></a><span class="lineno"><a class="line" href="classevo_1_1_event_lambda.html#a93c5d903988e461bc35703bf59c1e7d7">   66</a></span>&#160;    <a class="code" href="classevo_1_1_event_lambda.html#a93c5d903988e461bc35703bf59c1e7d7">EventLambda</a>(<span class="keyword">const</span> Lambda&amp; lambda) : lambda_(lambda) {</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    }</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;</div><div class="line"><a name="l00072"></a><span class="lineno"><a class="line" href="classevo_1_1_event_lambda.html#a61f930b2949fb45a62eee08e308621ba">   72</a></span>&#160;    <a class="code" href="classevo_1_1_event_lambda.html#a61f930b2949fb45a62eee08e308621ba">EventLambda</a>(<span class="keyword">const</span> <a class="code" href="classevo_1_1_event_lambda.html">EventLambda</a>&amp; src) : lambda_(src.lambda_) {</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    }</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;</div><div class="line"><a name="l00079"></a><span class="lineno"><a class="line" href="classevo_1_1_event_lambda.html#aded6c13933d3b5060ad40977428371e1">   79</a></span>&#160;    <a class="code" href="classevo_1_1_event_lambda.html">EventLambda</a>&amp; <a class="code" href="classevo_1_1_event_lambda.html#aded6c13933d3b5060ad40977428371e1">operator=</a>(<span class="keyword">const</span> <a class="code" href="classevo_1_1_event_lambda.html">EventLambda</a>&amp; src) {</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;        lambda_ = src.lambda_;</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;        <span class="keywordflow">return</span> *<span class="keyword">this</span>;</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    }</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    <span class="comment">// Doc by parent</span></div><div class="line"><a name="l00085"></a><span class="lineno"><a class="line" href="classevo_1_1_event_lambda.html#a3b26dbefa24299087ee65df579ed4314">   85</a></span>&#160;    <span class="keywordtype">bool</span> <a class="code" href="classevo_1_1_event_lambda.html#a3b26dbefa24299087ee65df579ed4314">operator()</a>() {</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;        <span class="keywordflow">return</span> lambda_();</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    }</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;<span class="keyword">private</span>:</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;    Lambda lambda_;</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;};</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> T=Event&gt;</div><div class="line"><a name="l00146"></a><span class="lineno"><a class="line" href="classevo_1_1_event_queue.html">  146</a></span>&#160;<span class="keyword">class </span><a class="code" href="classevo_1_1_event_queue.html">EventQueue</a> {</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;<span class="keyword">public</span>:</div><div class="line"><a name="l00148"></a><span class="lineno"><a class="line" href="classevo_1_1_event_queue.html#a7fa23586a8569aaa8e3a292ef7b79ca4">  148</a></span>&#160;    <span class="keyword">typedef</span> T <a class="code" href="classevo_1_1_event_queue.html#a7fa23586a8569aaa8e3a292ef7b79ca4">EventT</a>;       </div><div class="line"><a name="l00149"></a><span class="lineno"><a class="line" href="classevo_1_1_event_queue.html#a7ded91da6860042da9f07d8729332628">  149</a></span>&#160;    <span class="keyword">typedef</span> uint <a class="code" href="classevo_1_1_event_queue.html#a7ded91da6860042da9f07d8729332628">Size</a>;      </div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;</div><div class="line"><a name="l00151"></a><span class="lineno"><a class="line" href="classevo_1_1_event_queue.html#a1988e62d84cde679cc87afd3927bc338">  151</a></span>&#160;    <span class="keyword">static</span> <span class="keyword">const</span> Size DEFAULT_SIZE = 256;   </div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;</div><div class="line"><a name="l00156"></a><span class="lineno"><a class="line" href="classevo_1_1_event_queue.html#a8bdfae4e55d4a3299b7c071184dfb262">  156</a></span>&#160;    <a class="code" href="classevo_1_1_event_queue.html#a8bdfae4e55d4a3299b7c071184dfb262">EventQueue</a>(Size size=DEFAULT_SIZE) {</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;        ringbuf_size_ = adjust_size(size);</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;        ringbuf_ = <span class="keyword">new</span> T*[ringbuf_size_];</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;        ringbuf_size_mask_ = ringbuf_size_ - 1; <span class="comment">// mask: set all bits up to size</span></div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;        memset(ringbuf_, 0, <span class="keyword">sizeof</span>(T*) * ringbuf_size_);</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;        next_pos_.store(1);</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;        read_pos_.store(1);</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;    }</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;</div><div class="line"><a name="l00168"></a><span class="lineno"><a class="line" href="classevo_1_1_event_queue.html#a4c36db20a2779c5a46e872847892d51b">  168</a></span>&#160;    <a class="code" href="classevo_1_1_event_queue.html#a4c36db20a2779c5a46e872847892d51b">~EventQueue</a>() {</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;        <span class="keywordflow">if</span> (read_pos_.load() &lt;= cursor_pos_.load()) {</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;            assert( <span class="keyword">false</span> ); <span class="comment">// Queue should be empty</span></div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;        }</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;        <span class="keyword">delete</span> [] ringbuf_;</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    }</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;</div><div class="line"><a name="l00185"></a><span class="lineno"><a class="line" href="classevo_1_1_event_queue.html#a520e3dfff08d42af8b010a0c461b2391">  185</a></span>&#160;    <span class="keywordtype">void</span> <a class="code" href="classevo_1_1_event_queue.html#a520e3dfff08d42af8b010a0c461b2391">add</a>(T* event, ulongl spinwait_ns=1) {</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;        <span class="comment">// Claim a slot and wait for available capacity</span></div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;        <span class="keyword">const</span> uint64 seq = next_pos_.fetch_add(1, <a class="code" href="atomic_8h.html#a8dfa74e36dca551c16403ee10fa5e1de">EVO_ATOMIC_ACQ_REL</a>);</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;        <span class="keywordflow">while</span> (seq - read_pos_.load(<a class="code" href="atomic_8h.html#ac28cebe10f7fe0d287fc9458c6468e00">EVO_ATOMIC_ACQUIRE</a>) &gt;= ringbuf_size_)</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;            <a class="code" href="namespaceevo.html#ae7a097858f25ec94234e771a6bd2798b">sleepns</a>(spinwait_ns);</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;        <span class="comment">// Store event in queue</span></div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;        <a class="code" href="atomic_8h.html#a84f8b53675f41f58792d6b8f4b080f15">EVO_ATOMIC_FENCE</a>(<a class="code" href="atomic_8h.html#ac28cebe10f7fe0d287fc9458c6468e00">EVO_ATOMIC_ACQUIRE</a>);</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;        ringbuf_[seq &amp; ringbuf_size_mask_] = event;</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;        <a class="code" href="atomic_8h.html#a84f8b53675f41f58792d6b8f4b080f15">EVO_ATOMIC_FENCE</a>(<a class="code" href="atomic_8h.html#ab0f6dde635987768f3dd4326ec20032e">EVO_ATOMIC_RELEASE</a>);</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;        <span class="comment">// Wait for cursor to reach previous slot, then increment cursor to commit the write</span></div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;        <span class="keyword">const</span> uint64 prev_seq = seq - 1;</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;        <span class="keywordflow">while</span> (!cursor_pos_.compare_set(prev_seq, seq, <a class="code" href="atomic_8h.html#a8dfa74e36dca551c16403ee10fa5e1de">EVO_ATOMIC_ACQ_REL</a>, <a class="code" href="atomic_8h.html#ac28cebe10f7fe0d287fc9458c6468e00">EVO_ATOMIC_ACQUIRE</a>))</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;            <a class="code" href="namespaceevo.html#ae7a097858f25ec94234e771a6bd2798b">sleepns</a>(spinwait_ns);</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    }</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    <span class="keyword">template</span>&lt;<span class="keyword">class</span> U&gt;</div><div class="line"><a name="l00211"></a><span class="lineno"><a class="line" href="classevo_1_1_event_queue.html#a4ba89ae46bed1a1f6cbf982c76a81e14">  211</a></span>&#160;    <span class="keywordtype">void</span> <a class="code" href="classevo_1_1_event_queue.html#a4ba89ae46bed1a1f6cbf982c76a81e14">notify_multiwait</a>(U&amp; condmutex) {</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;        <span class="keywordflow">if</span> (condmutex.trylock()) { <span class="comment">// non-blocking</span></div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;            condmutex.notify();</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;            condmutex.unlock();</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;        }</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    }</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;</div><div class="line"><a name="l00225"></a><span class="lineno"><a class="line" href="classevo_1_1_event_queue.html#af268a62c13246b74b5428a296cdf714a">  225</a></span>&#160;    <span class="keywordtype">bool</span> <a class="code" href="classevo_1_1_event_queue.html#af268a62c13246b74b5428a296cdf714a">process</a>() {</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;        T* event;</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;        uint64 start, seq;</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;        start = seq = read_pos_.load(<a class="code" href="atomic_8h.html#ac28cebe10f7fe0d287fc9458c6468e00">EVO_ATOMIC_ACQUIRE</a>);</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;        <span class="keywordflow">while</span> (seq &lt;= cursor_pos_.load(<a class="code" href="atomic_8h.html#ac28cebe10f7fe0d287fc9458c6468e00">EVO_ATOMIC_ACQUIRE</a>)) {</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;            <span class="keyword">event</span> = ringbuf_[seq &amp; ringbuf_size_mask_];</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;            seq = read_pos_.fetch_add(1, <a class="code" href="atomic_8h.html#a8dfa74e36dca551c16403ee10fa5e1de">EVO_ATOMIC_ACQ_REL</a>) + 1;</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;            <span class="keywordflow">if</span> ((*event)())</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;                <span class="keyword">delete</span> event;</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;        }</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;        <span class="keywordflow">return</span> (seq &gt; start);</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    }</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    <span class="keyword">template</span>&lt;<span class="keyword">class</span> U&gt;</div><div class="line"><a name="l00247"></a><span class="lineno"><a class="line" href="classevo_1_1_event_queue.html#a6a1a08dbfbca319fd9800ae11b46afd1">  247</a></span>&#160;    <span class="keywordtype">bool</span> <a class="code" href="classevo_1_1_event_queue.html#a6a1a08dbfbca319fd9800ae11b46afd1">process_multi</a>(U&amp; mutex) {</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;        T* event;</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;        uint64 seq, count = 0;</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;        <span class="keyword">typename</span> U::Lock lock(mutex);</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;        seq = read_pos_.load(<a class="code" href="atomic_8h.html#a61f35423df8f0d4744d1f03ef38f8973">EVO_ATOMIC_RELAXED</a>);</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;        <span class="keywordflow">for</span> (; seq &lt;= cursor_pos_.load(<a class="code" href="atomic_8h.html#ac28cebe10f7fe0d287fc9458c6468e00">EVO_ATOMIC_ACQUIRE</a>); ++count) {</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;            <span class="keyword">event</span> = ringbuf_[seq &amp; ringbuf_size_mask_];</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;            read_pos_.fetch_add(1, <a class="code" href="atomic_8h.html#ab0f6dde635987768f3dd4326ec20032e">EVO_ATOMIC_RELEASE</a>);</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;            lock.unlock();</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;            <span class="keywordflow">if</span> ((*event)())</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;                <span class="keyword">delete</span> event;</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;            lock.lock();</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;            seq = read_pos_.load(<a class="code" href="atomic_8h.html#a61f35423df8f0d4744d1f03ef38f8973">EVO_ATOMIC_RELAXED</a>);</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;        }</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;        lock.unlock();</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;        <span class="keywordflow">return</span> (count &gt; 0);</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;    }</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    <span class="keyword">template</span>&lt;<span class="keyword">class</span> U&gt;</div><div class="line"><a name="l00277"></a><span class="lineno"><a class="line" href="classevo_1_1_event_queue.html#a37bab8c4d30b31d6e55616feb8794be8">  277</a></span>&#160;    <span class="keywordtype">void</span> <a class="code" href="classevo_1_1_event_queue.html#a37bab8c4d30b31d6e55616feb8794be8">process_multiwait</a>(U&amp; condmutex, <a class="code" href="classevo_1_1_atomic.html">AtomicInt</a>&amp; stopflag, ulong waitms=1) {</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;        T* event;</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;        uint64 seq;</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;        <span class="keyword">typename</span> U::Lock lock(condmutex);</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;        <span class="keywordflow">for</span> (;;) {</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;            seq = read_pos_.load(<a class="code" href="atomic_8h.html#a61f35423df8f0d4744d1f03ef38f8973">EVO_ATOMIC_RELAXED</a>);</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;            <span class="keywordflow">for</span> (; seq &lt;= cursor_pos_.load(<a class="code" href="atomic_8h.html#ac28cebe10f7fe0d287fc9458c6468e00">EVO_ATOMIC_ACQUIRE</a>);) {</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;                <span class="keyword">event</span> = ringbuf_[seq &amp; ringbuf_size_mask_];</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;                read_pos_.fetch_add(1, <a class="code" href="atomic_8h.html#ab0f6dde635987768f3dd4326ec20032e">EVO_ATOMIC_RELEASE</a>);</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;                lock.unlock();</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;                <span class="keywordflow">if</span> ((*event)())</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;                    <span class="keyword">delete</span> event;</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;                lock.lock();</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;                seq = read_pos_.load(<a class="code" href="atomic_8h.html#a61f35423df8f0d4744d1f03ef38f8973">EVO_ATOMIC_RELAXED</a>);</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;            }</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;            <span class="keywordflow">if</span> (stopflag.<a class="code" href="group___evo_thread.html#gab9174b503ce0983abdb5aaf7ddede488">load</a>(<a class="code" href="atomic_8h.html#a61f35423df8f0d4744d1f03ef38f8973">EVO_ATOMIC_RELAXED</a>))</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;            condmutex.wait(waitms, <span class="keyword">true</span>);</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;        }</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;        lock.unlock();</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;    }</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;<span class="keyword">private</span>:</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;    <span class="comment">// Disable copying</span></div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;    <a class="code" href="classevo_1_1_event_queue.html">EventQueue</a>(<span class="keyword">const</span> <a class="code" href="classevo_1_1_event_queue.html">EventQueue</a>&amp;);</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;    <a class="code" href="classevo_1_1_event_queue.html">EventQueue</a>&amp; operator=(<span class="keyword">const</span> <a class="code" href="classevo_1_1_event_queue.html">EventQueue</a>&amp;);</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;    <span class="comment">// Ring buffer</span></div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;    T**  ringbuf_;</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;    Size ringbuf_size_;         <span class="comment">// Must be a power of 2 for mask to work</span></div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;    Size ringbuf_size_mask_;    <span class="comment">// Mask for faster modulus</span></div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;    <span class="comment">// Positions increase to infinity (index = pos % ringbuf_size_), would take hundreds of years to max out 64 bits</span></div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;    <a class="code" href="classevo_1_1_atomic.html">AtomicUInt64</a> cursor_pos_;   <span class="comment">// Position of latest item committed to queue</span></div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;    <a class="code" href="classevo_1_1_atomic.html">AtomicUInt64</a> next_pos_;     <span class="comment">// Next write position in queue (cursor + 1 when no add() in progress)</span></div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;    <a class="code" href="classevo_1_1_atomic.html">AtomicUInt64</a> read_pos_;     <span class="comment">// Position of next item to read from queue (cursor + 1 when queue is empty)</span></div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;    <span class="comment">// Make sure size is within min/max and is a power of 2</span></div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;    <span class="keyword">static</span> Size adjust_size(Size size) {</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;        <span class="keyword">const</span> Size MIN_SIZE = 16;</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;        <span class="keyword">const</span> Size MAX_SIZE = (<a class="code" href="group___evo_algs.html#gac7d788acc8d7e6814dd41a0e9ac50ab4">std::numeric_limits&lt;Size&gt;::max</a>() &gt;&gt; 1) + 1;</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;        <span class="keywordflow">if</span> (size &lt;= MIN_SIZE)</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;            size = MIN_SIZE;</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (size &gt;= MAX_SIZE)</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;            size = MAX_SIZE;</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;            size = <a class="code" href="group___evo_core.html#ga8ff1b6fcb4218ca3a2b66ea26a154ef7">next_pow2</a>(size);</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;        <span class="keywordflow">return</span> size;</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;    }</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;};</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;}</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;<span class="preprocessor">#endif</span></div><div class="ttc" id="group___evo_algs_html_gac7d788acc8d7e6814dd41a0e9ac50ab4"><div class="ttname"><a href="group___evo_algs.html#gac7d788acc8d7e6814dd41a0e9ac50ab4">evo::max</a></div><div class="ttdeci">T &amp; max(T &amp;a, T &amp;b)</div><div class="ttdoc">Returns highest of given values. </div><div class="ttdef"><b>Definition:</b> alg.h:47</div></div>
<div class="ttc" id="classevo_1_1_atomic_html"><div class="ttname"><a href="classevo_1_1_atomic.html">evo::Atomic&lt; int &gt;</a></div></div>
<div class="ttc" id="classevo_1_1_event_lambda_html_aded6c13933d3b5060ad40977428371e1"><div class="ttname"><a href="classevo_1_1_event_lambda.html#aded6c13933d3b5060ad40977428371e1">evo::EventLambda::operator=</a></div><div class="ttdeci">EventLambda &amp; operator=(const EventLambda &amp;src)</div><div class="ttdoc">Assignment operator. </div><div class="ttdef"><b>Definition:</b> event.h:79</div></div>
<div class="ttc" id="atomic_8h_html_a8dfa74e36dca551c16403ee10fa5e1de"><div class="ttname"><a href="atomic_8h.html#a8dfa74e36dca551c16403ee10fa5e1de">EVO_ATOMIC_ACQ_REL</a></div><div class="ttdeci">#define EVO_ATOMIC_ACQ_REL</div><div class="ttdoc">Combined &quot;acquire&quot; &amp; &quot;release&quot; level memory barrier. </div><div class="ttdef"><b>Definition:</b> atomic.h:33</div></div>
<div class="ttc" id="structevo_1_1_event_html_af098c25159582e982ca735262b4df169"><div class="ttname"><a href="structevo_1_1_event.html#af098c25159582e982ca735262b4df169">evo::Event::operator()</a></div><div class="ttdeci">virtual bool operator()()=0</div><div class="ttdoc">Event function. </div></div>
<div class="ttc" id="classevo_1_1_event_queue_html_a4ba89ae46bed1a1f6cbf982c76a81e14"><div class="ttname"><a href="classevo_1_1_event_queue.html#a4ba89ae46bed1a1f6cbf982c76a81e14">evo::EventQueue::notify_multiwait</a></div><div class="ttdeci">void notify_multiwait(U &amp;condmutex)</div><div class="ttdoc">Notify an item has been added with multiple consumer threads. </div><div class="ttdef"><b>Definition:</b> event.h:211</div></div>
<div class="ttc" id="classevo_1_1_event_lambda_html"><div class="ttname"><a href="classevo_1_1_event_lambda.html">evo::EventLambda</a></div><div class="ttdoc">Implement Event using a lambda function (C++11). </div><div class="ttdef"><b>Definition:</b> event.h:59</div></div>
<div class="ttc" id="atomic_8h_html_a84f8b53675f41f58792d6b8f4b080f15"><div class="ttname"><a href="atomic_8h.html#a84f8b53675f41f58792d6b8f4b080f15">EVO_ATOMIC_FENCE</a></div><div class="ttdeci">#define EVO_ATOMIC_FENCE(MEM_ORDER)</div><div class="ttdoc">Sets a memory fence/barrier. </div><div class="ttdef"><b>Definition:</b> atomic.h:52</div></div>
<div class="ttc" id="group___evo_core_html_ga8ff1b6fcb4218ca3a2b66ea26a154ef7"><div class="ttname"><a href="group___evo_core.html#ga8ff1b6fcb4218ca3a2b66ea26a154ef7">evo::next_pow2</a></div><div class="ttdeci">T next_pow2(T v)</div><div class="ttdoc">Get next power of 2 equal to or greater than given number. </div><div class="ttdef"><b>Definition:</b> type.h:1932</div></div>
<div class="ttc" id="classevo_1_1_event_lambda_html_a3b26dbefa24299087ee65df579ed4314"><div class="ttname"><a href="classevo_1_1_event_lambda.html#a3b26dbefa24299087ee65df579ed4314">evo::EventLambda::operator()</a></div><div class="ttdeci">bool operator()()</div><div class="ttdoc">Event function. </div><div class="ttdef"><b>Definition:</b> event.h:85</div></div>
<div class="ttc" id="atomic_8h_html_a61f35423df8f0d4744d1f03ef38f8973"><div class="ttname"><a href="atomic_8h.html#a61f35423df8f0d4744d1f03ef38f8973">EVO_ATOMIC_RELAXED</a></div><div class="ttdeci">#define EVO_ATOMIC_RELAXED</div><div class="ttdoc">Relaxed memory ordering, used between start/end memory barriers. </div><div class="ttdef"><b>Definition:</b> atomic.h:21</div></div>
<div class="ttc" id="classevo_1_1_event_queue_html_a37bab8c4d30b31d6e55616feb8794be8"><div class="ttname"><a href="classevo_1_1_event_queue.html#a37bab8c4d30b31d6e55616feb8794be8">evo::EventQueue::process_multiwait</a></div><div class="ttdeci">void process_multiwait(U &amp;condmutex, AtomicInt &amp;stopflag, ulong waitms=1)</div><div class="ttdoc">Process queued events until stopflag is set, allowing multiple consumer threads, and waiting with con...</div><div class="ttdef"><b>Definition:</b> event.h:277</div></div>
<div class="ttc" id="structevo_1_1_event_html_aa28124883bfb17601f85db7e635094b1"><div class="ttname"><a href="structevo_1_1_event.html#aa28124883bfb17601f85db7e635094b1">evo::Event::~Event</a></div><div class="ttdeci">virtual ~Event()</div><div class="ttdoc">Destructor. </div><div class="ttdef"><b>Definition:</b> event.h:37</div></div>
<div class="ttc" id="classevo_1_1_event_queue_html_a6a1a08dbfbca319fd9800ae11b46afd1"><div class="ttname"><a href="classevo_1_1_event_queue.html#a6a1a08dbfbca319fd9800ae11b46afd1">evo::EventQueue::process_multi</a></div><div class="ttdeci">bool process_multi(U &amp;mutex)</div><div class="ttdoc">Process queued events and return, allowing multiple consumer threads. </div><div class="ttdef"><b>Definition:</b> event.h:247</div></div>
<div class="ttc" id="atomic_8h_html_ac28cebe10f7fe0d287fc9458c6468e00"><div class="ttname"><a href="atomic_8h.html#ac28cebe10f7fe0d287fc9458c6468e00">EVO_ATOMIC_ACQUIRE</a></div><div class="ttdeci">#define EVO_ATOMIC_ACQUIRE</div><div class="ttdoc">Start &quot;acquire&quot; memory ordering barrier, usually followed by a matching &quot;release&quot; barrier...</div><div class="ttdef"><b>Definition:</b> atomic.h:27</div></div>
<div class="ttc" id="classevo_1_1_event_queue_html_a7ded91da6860042da9f07d8729332628"><div class="ttname"><a href="classevo_1_1_event_queue.html#a7ded91da6860042da9f07d8729332628">evo::EventQueue::Size</a></div><div class="ttdeci">uint Size</div><div class="ttdoc">Queue size type. </div><div class="ttdef"><b>Definition:</b> event.h:149</div></div>
<div class="ttc" id="atomic_8h_html"><div class="ttname"><a href="atomic_8h.html">atomic.h</a></div><div class="ttdoc">Evo atomic types. </div></div>
<div class="ttc" id="structevo_1_1_event_html_a85b9e8172cffad1f169d55688e49a72f"><div class="ttname"><a href="structevo_1_1_event.html#a85b9e8172cffad1f169d55688e49a72f">evo::Event::Event</a></div><div class="ttdeci">Event()</div><div class="ttdoc">Constructor. </div><div class="ttdef"><b>Definition:</b> event.h:33</div></div>
<div class="ttc" id="classevo_1_1_event_queue_html_a7fa23586a8569aaa8e3a292ef7b79ca4"><div class="ttname"><a href="classevo_1_1_event_queue.html#a7fa23586a8569aaa8e3a292ef7b79ca4">evo::EventQueue::EventT</a></div><div class="ttdeci">T EventT</div><div class="ttdoc">Event type used </div><div class="ttdef"><b>Definition:</b> event.h:148</div></div>
<div class="ttc" id="namespaceevo_html"><div class="ttname"><a href="namespaceevo.html">evo</a></div><div class="ttdoc">Evo C++ Library namespace. </div><div class="ttdef"><b>Definition:</b> alg.h:11</div></div>
<div class="ttc" id="atomic_8h_html_ab0f6dde635987768f3dd4326ec20032e"><div class="ttname"><a href="atomic_8h.html#ab0f6dde635987768f3dd4326ec20032e">EVO_ATOMIC_RELEASE</a></div><div class="ttdeci">#define EVO_ATOMIC_RELEASE</div><div class="ttdoc">Release (end) memory ordering barrier started with &quot;consume&quot; or &quot;acquire&quot; barrier. </div><div class="ttdef"><b>Definition:</b> atomic.h:30</div></div>
<div class="ttc" id="structevo_1_1_event_html"><div class="ttname"><a href="structevo_1_1_event.html">evo::Event</a></div><div class="ttdoc">Event base type used with EventQueue. </div><div class="ttdef"><b>Definition:</b> event.h:31</div></div>
<div class="ttc" id="namespaceevo_html_ae7a097858f25ec94234e771a6bd2798b"><div class="ttname"><a href="namespaceevo.html#ae7a097858f25ec94234e771a6bd2798b">evo::sleepns</a></div><div class="ttdeci">bool sleepns(ulongl nsec)</div><div class="ttdoc">Sleep for number of nanoseconds. </div><div class="ttdef"><b>Definition:</b> sys.h:706</div></div>
<div class="ttc" id="classevo_1_1_event_queue_html_a520e3dfff08d42af8b010a0c461b2391"><div class="ttname"><a href="classevo_1_1_event_queue.html#a520e3dfff08d42af8b010a0c461b2391">evo::EventQueue::add</a></div><div class="ttdeci">void add(T *event, ulongl spinwait_ns=1)</div><div class="ttdoc">Add an event to queue. </div><div class="ttdef"><b>Definition:</b> event.h:185</div></div>
<div class="ttc" id="classevo_1_1_event_queue_html_af268a62c13246b74b5428a296cdf714a"><div class="ttname"><a href="classevo_1_1_event_queue.html#af268a62c13246b74b5428a296cdf714a">evo::EventQueue::process</a></div><div class="ttdeci">bool process()</div><div class="ttdoc">Process queued events and return. </div><div class="ttdef"><b>Definition:</b> event.h:225</div></div>
<div class="ttc" id="classevo_1_1_event_queue_html_a4c36db20a2779c5a46e872847892d51b"><div class="ttname"><a href="classevo_1_1_event_queue.html#a4c36db20a2779c5a46e872847892d51b">evo::EventQueue::~EventQueue</a></div><div class="ttdeci">~EventQueue()</div><div class="ttdoc">Destructor. </div><div class="ttdef"><b>Definition:</b> event.h:168</div></div>
<div class="ttc" id="classevo_1_1_event_lambda_html_a61f930b2949fb45a62eee08e308621ba"><div class="ttname"><a href="classevo_1_1_event_lambda.html#a61f930b2949fb45a62eee08e308621ba">evo::EventLambda::EventLambda</a></div><div class="ttdeci">EventLambda(const EventLambda &amp;src)</div><div class="ttdoc">Copy constructor. </div><div class="ttdef"><b>Definition:</b> event.h:72</div></div>
<div class="ttc" id="classevo_1_1_event_lambda_html_a93c5d903988e461bc35703bf59c1e7d7"><div class="ttname"><a href="classevo_1_1_event_lambda.html#a93c5d903988e461bc35703bf59c1e7d7">evo::EventLambda::EventLambda</a></div><div class="ttdeci">EventLambda(const Lambda &amp;lambda)</div><div class="ttdoc">Constructor. </div><div class="ttdef"><b>Definition:</b> event.h:66</div></div>
<div class="ttc" id="classevo_1_1_event_queue_html_a8bdfae4e55d4a3299b7c071184dfb262"><div class="ttname"><a href="classevo_1_1_event_queue.html#a8bdfae4e55d4a3299b7c071184dfb262">evo::EventQueue::EventQueue</a></div><div class="ttdeci">EventQueue(Size size=DEFAULT_SIZE)</div><div class="ttdoc">Constructor. </div><div class="ttdef"><b>Definition:</b> event.h:156</div></div>
<div class="ttc" id="group___evo_thread_html_gab9174b503ce0983abdb5aaf7ddede488"><div class="ttname"><a href="group___evo_thread.html#gab9174b503ce0983abdb5aaf7ddede488">evo::Atomic::load</a></div><div class="ttdeci">T load(MemOrder mem_order=std::memory_order_seq_cst) const</div><div class="ttdoc">Load and return current value. </div></div>
<div class="ttc" id="classevo_1_1_event_lambda_html_a6f89de73c7b46231ac5a1b220123c16a"><div class="ttname"><a href="classevo_1_1_event_lambda.html#a6f89de73c7b46231ac5a1b220123c16a">evo::EventLambda::Lambda</a></div><div class="ttdeci">std::function&lt; bool()&gt; Lambda</div><div class="ttdoc">Lambda function type for Event. </div><div class="ttdef"><b>Definition:</b> event.h:61</div></div>
<div class="ttc" id="classevo_1_1_event_queue_html"><div class="ttname"><a href="classevo_1_1_event_queue.html">evo::EventQueue</a></div><div class="ttdoc">Lock-free event processing queue. </div><div class="ttdef"><b>Definition:</b> event.h:146</div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue May 7 2019 17:30:48 for Evo C++ Library v0.5.1 by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
